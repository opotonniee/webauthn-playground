<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link id="favicon" rel="icon" href="img/favicon.ico" type="image/x-icon" />
  <title>WebAuthn Playground</title>

  <link rel="stylesheet" href="css/style.css" />

  <style>
    table#support,
    #support th,
    #support td,
    #parsed-data,
    #parsed-data td {
      border: 1px black solid;
      border-collapse: collapse;
    }

    h2 {
      font-size: 120%;
      font-weight: bold;
      margin: 10px 0 5px 0;
    }

    td,
    th {
      padding: 5px;
    }

    #support td:not(:first-child) {
      text-align: center;
    }

    #config,
    #parsed-data {
      width: 100%;
    }

    #config td,
    #parsed-data td {
      width: 100%;
      word-wrap: normal;
    }

    #config td:first-child,
    #parsed-data td:first-child {
      width: fit-content;
    }

    #config input {
      margin: 0;
      display: initial;
    }

    #credId,
    #userName,
    #userLogin input {
      width: 98%;
      max-width: 800px;
    }

    .io-span {
      display: table-cell;
      width: 600px;
    }

    .io-textarea {
      width: 95%;
      height: 300px;
    }

    .io-title {
      line-height: 30px;
      background-color: rgba(211, 211, 211, 0.809);
      width: 95%;
    }

    .not-selectable {
      user-select: none;
    }

    .hidden {
      display: none;
    }

    .header-option {
      font-size: 80%;
      font-weight: 100;
    }

    .clickable {
      margin: 0 5px;
    }

    .clickable:hover {
      cursor: pointer;
    }

    @media screen and (max-width: 480px) {
      body {
        font-size: 80%;
      }

      .io-title {
        width: initial;
      }

      .io-span {
        display: block;
        width: initial;
      }

      .io-textarea {
        width: 99%;
        height: 200px;
      }
    }
  </style>
</head>

<body>

  <h2>Support of WebAuthn</h2>
  <table id="support">
    <tr>
      <th>Lib</th>
      <th>WebAuthn</th>
      <th>Autofill</th>
      <th>Paltform</th>
    </tr>
    <tr>
      <td>IdCloud</td>
      <td id="idcwa"></td>
      <td id="idcaf"></td>
      <td id="idcpf"></td>
    </tr>
    <tr>
      <td>SimpleWebAuthn</td>
      <td id="swawa"></td>
      <td id="swaaf"></td>
      <td id="swapf"></td>
    </tr>
  </table>

  <h2 class="not-selectable">
    <span id="jslib-span">WebAuthn Operations</span>
    <span id="jslib-cfg" title="Configuration" class="clickable">‚öôÔ∏è</span>
    <select id="jslib" class="header-option hidden">
      <option value="0">IdCloud JS</option>
      <option value="2">SimpleWebAuthn JS</option>
    </select>
  </h2>
  <div>
    Request:
    <select id="request">
      <option value="0">Register</option>
      <option value="1">Login</option>
    </select>
    <button id="run">Execute</button>
    <span id="status" class="result"></span>
  </div>
  <table id="config"></table>
  <span class="io-span">
    <h2 class="io-title not-selectable">
      Input
      <span id="reset-input" title="Reset JSON Input" class="clickable">üßΩ</span>
    </h2>
    <textarea id="input" class="io-textarea">
    </textarea>
  </span>
  <span class="io-span">
    <h2 class="io-title not-selectable">
      Output
      <span id="parse-output" title="Parse JSON Output" class="clickable">üîé‚§µ</span>
    </h2>
    <textarea class="result io-textarea" id="output">
    </textarea>
  </span>
  <div>
    <h2 class="not-selectable">Parsed Output</h2>
    <table id="parsed-data" class="result"></table>
  </div>

  <footer>
    <a href="https://github.com/opotonniee/webauthn-playground">Source code on GitHub</a>
  </footer>

  <script src="js/jquery-3.6.4.slim.min.js"></script>
  <script src="js/simplewebauthn.min.js"></script>
  <script src="js/base64url-arraybuffer.js"></script>
  <script src="js/idcloud.js"></script>
  <script src="js/jsconfig.js"></script>
  <script src="js/cbor.js"></script>

  <script>

    let idCloud;


    function validateRegister(options) {
      if (!config.userName) {
        throw "User name is mandatory";
      }
    }

    async function idcRegister(options) {
      validateRegister(options);
      return idCloud.enroll(options, { getCredName: () => { return "test"; } });
    }

    async function idcLogin(options, reqOptions) {
      return idCloud.authenticate(options, reqOptions);
    }

    async function swaRegister(options) {
      validateRegister(options);
      return SimpleWebAuthnBrowser.startRegistration(options);
    }

    async function swaLogin(options, reqOptions) {
      return SimpleWebAuthnBrowser.startAuthentication(options, reqOptions !== undefined);
    }

    let operations = [idcRegister, idcLogin, swaRegister, swaLogin];
    let operation;
    let RP_NAME = "webauthn-playground";
    let requestConfigurators = [configureRegister, configureLogin];
    const REQ_REGISTER = {
      "rp": {
        origins: [
          origin
        ],
        id: origin.hostname,
        name: RP_NAME
      },
      "challenge": "AAABeB78HrIemh1jTdJICr_3QG_RMOhp",
      "pubKeyCredParams": [
        {
          type: "public-key",
          alg: -257
        }, {
          type: "public-key",
          alg: -258
        }, {
          type: "public-key",
          alg: -259
        }, {
          type: "public-key",
          alg: -35
        }, {
          type: "public-key",
          alg: -36
        }, {
          type: "public-key",
          alg: -65535
        }, {
          type: "public-key",
          alg: -7
        }, {
          type: "public-key",
          alg: -8
        }
      ],
      "excludeCredentials": [],
      "timeout": 120000
    };
    const REQ_LOGIN = {
      "challenge": "AAABeB78HrIemh1jTdJICr_3QG_RMOhp",
      "timeout": 120000,
      "rpId": origin.hostname,
      "allowCredentials": [],
      "extensions": {
        "thalesgroup_txn_ext_v1": {
          "txnDigest": "QhPf8nrP8Ocil/wWdN/rmu4HtFCSOK/zSoNUmhMrc8s=",
          "txnDetails": [
            {
              "key1": "value1"
            },
            {
              "key2": "value2"
            }
          ],
          "nonce": "AAABdhzkZmLlTio_PX1JhKOF7gOQzUSV",
          "challengeDerivationScheme": 1
        }
      }
    };
    let requests;
    function resetRequests() {
      requests = [JSON.parse(JSON.stringify(REQ_REGISTER)), JSON.parse(JSON.stringify(REQ_LOGIN))];
    }
    resetRequests();

    let jsc = new JsConfig(true)
      .add("userName", JsConfig.textType(".*"), "alex muller", "user name", "0")
      .add("credId", JsConfig.textType(" *[^ ]* *"), "", "Expected credential id", "1")
      .add("autoFill", JsConfig.boolType(), false, "Use last credential id", "1")
      .add("authenticatorAttachment", JsConfig.listType("platform", "cross-platform", ""), "", "Authenticator type", "0")
      .add("residentKey", JsConfig.listType("required", "preferred", "discouraged", ""), "preferred", "FIDO credential filter", "0")
      .add("userVerification", JsConfig.listType("required", "preferred", "discouraged"), "preferred", "FIDO credential filter", "0 1")
      .add("attestation", JsConfig.listType("none", "direct", "indirect"), "none", "Requested FIDO attestation type", "0");
    let config = jsc._;

    let isAutoFillSupported = false;
    async function showSupport() {
      idCloud = new IdCloud({
        fido: {
          usePlatformFIDO: config.authenticatorAttachment != "cross-platform",
          useRoamingFIDO: config.authenticatorAttachment != "platform"
        }
      });
      $("#idcwa").text(await idCloud.isFido2Available() ? "‚úÖ" : "‚ùå");
      isAutoFillSupported = await idCloud.isAutoFillSupported();
      $("#idcaf").text(isAutoFillSupported ? "‚úÖ" : "‚ùå");
      $("#idcpf").text("N/A");
      $("#swawa").text(SimpleWebAuthnBrowser.browserSupportsWebAuthn() ? "‚úÖ" : "‚ùå");
      $("#swaaf").text(await SimpleWebAuthnBrowser.browserSupportsWebAuthnAutofill() ? "‚úÖ" : "‚ùå");
      $("#swapf").text(await SimpleWebAuthnBrowser.platformAuthenticatorIsAvailable() ? "‚úÖ" : "‚ùå");
    }
    showSupport();

    const capitalize = (str, lower = false) =>
      (lower ? str.toLowerCase() : str).replace(/(?:^|\s|["'([{])+\S/g, match => match.toUpperCase());

    function configureRegister(request) {
      $("#userLogin").hide();
      cancelAutoFill();
      request.authenticatorSelection = {
        residentKey: config.residentKey ? config.residentKey : undefined,
        requireResidentKey: config.residentKey ? config.residentKey == "required" : undefined,
        userVerification: config.userVerification ? config.userVerification : undefined,
        authenticatorAttachment: config.authenticatorAttachment ? config.authenticatorAttachment : undefined
      };
      request.attestation = config.attestation;
      request.user = { // all fields are REQUIRED
        name: config.userName,
        displayName: capitalize(config.userName, true),
        // id can be returned as the userHandle in authentication response (resident key?),
        // Authenticators overwrite existing discoverable credentials that have the same rp.id and user.id
        // IdCloud provides it as a base64 encoded bytes array, while SimpleWebAuthn uses the string's bytes
        id: base64url.encode(Uint8Array.from(config.userName, c => c.charCodeAt(0)))
      };
    }

    let autoFillAbortController;
    function cancelAutoFill() {
      if (autoFillAbortController) {
        // TODO cancel
        !autoFillAbortController.aborted && autoFillAbortController.abort();
        autoFillAbortController = undefined;
      }
    }

    function configureLogin(request) {
      cancelAutoFill();
      let useAutoFill = config.autoFill && isAutoFillSupported;
      $("#credId").closest('tr').toggle(!useAutoFill);
      $("#autoFill").closest('tr').toggle(isAutoFillSupported);
      $("#userLogin").toggle(useAutoFill);
      request.allowCredentials = !useAutoFill && config.credId ? [{
        "type": "public-key",
        "id": config.credId
      }] : [];
      request.userVerification = config.userVerification ? config.userVerification : undefined;
      if (useAutoFill) {
        // https://web.dev/passkey-form-autofill/
        // https://developers.yubico.com/WebAuthn/Concepts/Passkey_Autofill/Implementation_Guidance/Simple_Autofill_Flow.html
        // launch autofill
        autoFillAbortController = new AbortController();
        setTimeout(() => {
          console.log("start auto fill");
          $("#userLogin input").focus();
          runRequest({
            signal: autoFillAbortController.signal,
            mediation: "conditional"
          });
        }, 500);
      }
    }

    function configChanged() {
      localStorage.setItem("webauthn_pg_tests", JSON.stringify(config));
      updateConfig(getRequest());
      showSupport();
    }
    jsc.onChange(configChanged)
      .setConfig(localStorage.getItem("webauthn_pg_tests"))
      .showConfigTable($("#config"), false);
    $("#config").prepend('<tr id="userLogin"><td>Auto fill:</td><td><input type="text" autoComplete="username webauthn" /></td></tr>');

    function stringifyUint8ArrayAsBase64(key, value) {
      if (value.buffer && value.byteLength) {
        return base64url.encode(value);
      } else {
        return value;
      }
    }

    function array2hex(u8array) {
      return Array.from(u8array).map(b => ("0" + b.toString(16)).slice(-2)).join('');
    }

    function getRequest() {
      let reqId = Number.parseInt($("#request").val());
      let jsLibId = Number.parseInt($("#jslib").val());
      return {
        request: requests[reqId],
        configurator: requestConfigurators[reqId],
        operation: operations[reqId + jsLibId],
        class: "." + reqId
      };
    }

    function updateConfig(req) {
      req.configurator(req.request);
      $("#input").val(JSON.stringify(req.request, null, 2));
    }

    function updateRequest() {
      $(".result").empty();
      $(".result").val("");
      $("#config tr").hide();
      let req = getRequest();
      operation = req.operation;
      $(req.class).show();
      updateConfig(req);
    }
    updateRequest();
    $("#request").on("change", updateRequest);

    // JS lib selector
    function hideJsSelector() {
      updateRequest();
      $("#jslib").hide();
      $("#jslib-cfg").show();
    }
    $("#jslib-cfg").on("click", () => {
      $("#jslib-cfg").hide();
      $("#jslib").show();
      $("#jslib").mousedown();
    });
    $("#jslib").on("change", hideJsSelector);
    $("#jslib-span").on("click", hideJsSelector);

    // Reset JSON input
    $("#reset-input").on("click", () => {
      resetRequests();
      configChanged();
      readInput();
    });

    // Parse JSON output
    $("#parse-output").on("click", () => {
      parseResult();
    });

    function setDisabled(selector, isDisabled) {
      $(selector).attr("disabled", isDisabled);
    }

    function readInput() {
      let disableInputs = false;
      let jsonInput;
      try {
        jsonInput = JSON.parse($("#input").val());
        $("#input").removeClass("error");
      } catch (jsonErr) {
        $("#input").addClass("error");
        disableInputs = true;
      }
      setDisabled("input, button, select", disableInputs);
      return jsonInput;
    }
    $("#input").on("keyup", () => {
      readInput();
    });

    function parseResult(result) {

      function addRow(name, value) {
        $("#parsed-data").append(`<tr><td>${name}: </td><td>${value}</td></tr>`);
      }

      function addAuthData(authenticatorData) {
        /*
        rpIdHash: 32 	SHA-256 hash of the RP ID the credential is scoped to.
        flags 	1 	Flags (bit 0 is the least significant bit):
          Bit 0: User Present (UP)
          Bit 1: Reserved for future use (RFU1).
          Bit 2: User Verified (UV)
          Bit 3: Backup Eligibility (BE).
          Bit 4: Backup State (BS).
          Bit 5: Reserved for future use (RFU2).
          Bit 6: Attested credential data included (AT).
          Bit 7: Extension data included (ED).
        signCount 	4 	Signature counter, 32-bit unsigned big-endian integer.
        attestedCredentialData 	variable (if present)
        extensions 	variable (if present) 	CBOR Extension-defined authenticator data.
        */
        let authDesc = "rpIdHash: " + base64url.encode(new Int8Array(authenticatorData.slice(0, 32)));
        const flag = new Int8Array(authenticatorData.slice(32, 33))[0];
        let flags = [];
        (flag & 0x01) && flags.push("User Present");
        (flag & 0x04) && flags.push("User Verified");
        (flag & 0x08) && flags.push("Backup Eligible");
        (flag & 0x10) && flags.push("Backed-up");
        (flag & 0x40) && flags.push("Attested data");
        (flag & 0x80) && flags.push("Extension data");
        const counter = new DataView(new Uint8Array(authenticatorData.slice(33, 37)).buffer).getUint32();
        authDesc += "<br/>Flags: "
          + "0b" + ("00000000" + flag.toString(2)).slice(-8)
          + (flags.length ? `  (${flags.toString()})` : "");
        authDesc += "<br/>Counter: " + counter;
        if (flag & 0x40) {
          /*
          attestedCredentialData:
            AAGUID: 16
            CredId Len: 2
            CredId
            COSE Pub key: 77
          */

          let aaguidHexa = array2hex(new Uint8Array(authenticatorData.slice(37, 53)));
          let aaguid = `${aaguidHexa.slice(0, 8)}-${aaguidHexa.slice(8, 12)}-${aaguidHexa.slice(12, 16)}-${aaguidHexa.slice(16, 20)}-${aaguidHexa.slice(20)}`;
          if (aaguid != "00000000-0000-0000-0000-000000000000") {
            aaguid = `<a target="_blank" href="https://opotonniee.github.io/fido-mds-explorer/?aaguid=${aaguid}">${aaguid}</a>`;
          }
          authDesc += "<br/>AAGUID: " + aaguid;

          const credIdLen = new DataView(new Int8Array(authenticatorData.slice(53, 55)).buffer).getUint16();
          const credId = base64url.encode(new Int8Array(authenticatorData.slice(55, 55 + credIdLen)));
          $("#credId").val(credId);
          jsc.readConfigTable();
          authDesc += "<br/>CredId: " + credId;
          authDesc += "<br/>Pub Key: " + base64url.encode(new Int8Array(authenticatorData.slice(55 + credIdLen, 55 + credIdLen + 77)));
        }
        addRow("Authenticator Data", authDesc);
      }

      function showX5c(x5c) {
        let res = "<br/>Certificates: <ul>";
        for (cert of x5c) {
          const b64cert = base64url.encode(cert).replaceAll("_", "/").replaceAll("-", "+");
          res += `<li><a target="_blank" href="https://gchq.github.io/CyberChef/#recipe=Parse_X.509_certificate('Raw')&input=${encodeURIComponent(b64cert)}">üîé</a> - <a target="_blank" href="https://opotonniee.github.io/fido-mds-explorer/?x5c=${b64cert}">${b64cert}</a></li>`;
        }
        res += "</ul>";
        return res;
      }

      $("#parsed-data").empty();
      if (!result) {
        try {
          let output = $("#output").val();
          if (!output) {
            return;
          }
          result = JSON.parse(output);
        } catch (error) {
          $("#status").text("Error: JSON result is not valid");
          return;
        }
      }
      if (result.response.clientDataJSON) {
        addRow("Client Data", "<pre>" + JSON.stringify(
          JSON.parse(new TextDecoder().decode(base64url.decode(result.response.clientDataJSON))),
          undefined, 2) + "</pre>");
      }
      if (result.response.authenticatorData) {
        addAuthData(base64url.decode(result.response.authenticatorData));
      }
      if (result.response.attestationObject) {
        const attObj = CBOR.decode(base64url.decode(result.response.attestationObject));
        console.log("Attestation Object", attObj);
        addAuthData(attObj.authData);
        let attDesc;
        if (attObj.fmt != "none") {
          attDesc = "Format: " + attObj.fmt + "<br/>";
          if (attObj.fmt == "android-safetynet") {
            const jwtBody = new TextDecoder().decode(attObj.attStmt.response).split('.')[1];
            attDesc += "<pre>" + JSON.stringify(JSON.parse(new TextDecoder().decode(base64url.decode(jwtBody))),
              stringifyUint8ArrayAsBase64, 2) + "</pre>";
          } else if (attObj.fmt == "fido-u2f") {
            attDesc += "<br/>Signature: " + base64url.encode(attObj.attStmt.sig);
            attDesc += showX5c(attObj.attStmt.x5c);
          } else if (attObj.fmt == "packed") {
            attDesc = "Format: " + attObj.fmt + (attObj.attStmt.x5c ? " (Full)" : " (Self)") + "<br/>";
            if (attObj.attStmt.x5c) {
              attDesc = "Format: packed (Full)<br/>";
              attDesc += showX5c(attObj.attStmt.x5c);
            } else if (attObj.attStmt.ecdaaKeyId) {
              attDesc = "Format: packed (ecdaa)<br/>";
              attDesc += "<pre>" + JSON.stringify(attObj.attStmt, stringifyUint8ArrayAsBase64, 2) + "</pre>";
            } else {
              attDesc = "Format: packed (self)<br/>";
              attDesc += "<pre>" + JSON.stringify(attObj.attStmt, stringifyUint8ArrayAsBase64, 2) + "</pre>";
            }
          } else {
            attDesc += "<pre>" + JSON.stringify(attObj.attStmt, stringifyUint8ArrayAsBase64, 2) + "</pre>";
          }
          addRow("Attestation Statement", attDesc);
        }
      }
      if (result.response.getTransports) {
        addRow("Transports", result.response.getTransports().toString());
      }
      if (result.response.getPublicKeyAlgorithm) {
        addRow("Key algo", result.response.getPublicKeyAlgorithm());
      }

    }

    async function runRequest(reqOptions) {
      $(".result").empty();
      $(".result").val("");
      try {
        let jsonInput = readInput();
        if (!jsonInput) {
          return;
        }
        let output = await operation(jsonInput, reqOptions);
        $("#status").text("ok");
        $("#output").val(JSON.stringify(output, null, 2));
        parseResult(output);
      } catch (err) {
        if (reqOptions) {
          console.error("auto fill cancelled");
        } else {
          $("#status").text("error: " + err);
          console.error(err);
        }
      }
    }

    $("#run").on("click", () => {
      cancelAutoFill();
      runRequest();
    });

  </script>
</body>

</html>